<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>小六壬在線推算</title>
  <script src="https://cdn.jsdelivr.net/npm/solarlunar@2.0.0/lib/solarlunar.min.js"></script>
  <style>
    body { font-family: "微软雅黑", sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #fdf6e3; color: #333; line-height: 1.6; }
    h1 { text-align: center; color: #d2691e; border-bottom: 2px solid #d2691e; padding-bottom: 10px; }
    .info-card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
    #usageInfo { font-weight: bold; color: #d2691e; text-align: center; }
    input[type="text"] { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
    button { width: 100%; padding: 12px; background-color: #d2691e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-bottom: 10px; }
    button:hover { background-color: #b25014; }
    #result { margin-top: 20px; padding: 15px; background: #fffaf0; border-left: 5px solid #d2691e; display: none; white-space: pre-wrap; }
    .qr-container { display: none; text-align: center; border: 2px dashed #d2691e; padding: 20px; background: #fff; margin-top: 20px; }
    .qr-container img { width: 200px; height: 200px; margin: 10px 0; }
    .pay-btn { background-color: #28a745; }
    .pay-btn:hover { background-color: #218838; }
  </style>
</head>
<body>

  <h1>☯ 小六壬占卜</h1>
  
  <div class="info-card">
    <p class="tip">此法源於李淳風《六壬時課》，依據當前農曆月、日、時推算。</p >
    <div id="usageInfo">正在初始化...</div>
  </div>

  <input type="text" id="question" placeholder="請輸入心中所求之事（如：今日出行）">
  <button id="calculateBtn">立即推算</button>

  <div id="result"></div>

  <div class="qr-container" id="qrContainer">
    <p style="color: #e74c3c; font-weight: bold;">免費次數已用完</p >
    <p>支付 <b>¥2</b> 即可解鎖本次及後續 1 次測算</p >
    <img src="alipay_qr.png" alt="請上傳你的收款碼">
    <button class="pay-btn" id="confirmPayBtn">我已支付，立即查看結果</button>
  </div>

  <script>
    const liurenData = [
      { name: "大安", type: "吉", desc: "大安事事昌，求財在南方。失物去不遠，宅舍保安康。" },
      { name: "留連", type: "凶", desc: "留連事難成，求謀日未明。官事只宜緩，去者未回程。" },
      { name: "速喜", type: "吉", desc: "速喜喜來臨，求財向南行。失物午未間，逢人路上尋。" },
      { name: "赤口", type: "凶", desc: "赤口主口舌，官非切宜防。失物急去尋，行人有驚慌。" },
      { name: "小吉", type: "吉", desc: "小吉最吉祥，路上好商量。陰人來報喜，失物在坤方。" },
      { name: "空亡", type: "凶", desc: "空亡事不祥，陰人少乖張。求財無利益，行人有災殃。" }
    ];

    // 初始化存儲
    let usage = parseInt(localStorage.getItem('lr_usage') || '0');
    let extra = parseInt(localStorage.getItem('lr_extra') || '0');
    const FREE_LIMIT = 5;

    function getRemaining() {
      return Math.max((FREE_LIMIT + extra) - usage, 0);
    }

    function updateUI() {
      const remain = getRemaining();
      document.getElementById('usageInfo').innerText = `可用次數：${remain} (已使用：${usage})`;
      if (remain > 0) {
        document.getElementById('qrContainer').style.display = 'none';
      }
    }

    // 核心算法：獲取農曆並計算
    function doCalculation() {
      const q = document.getElementById('question').value.trim();
      if (!q) return alert("請輸入問題");

      // 1. 獲取當前時間
      const now = new Date();
      const solarYear = now.getFullYear();
      const solarMonth = now.getMonth() + 1;
      const solarDay = now.getDate();
      const hour = now.getHours();

      // 2. 轉換為農曆 (使用 solarlunar 庫)
      const lunar = solarLunar.solar2lunar(solarYear, solarMonth, solarDay);
      
      // 3. 計算時辰數 (子時=1, 丑時=2...)
      const hourIndex = Math.floor((hour + 1) / 2) % 12 + 1;
      const hourName = ["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"][Math.floor((hour + 1) / 2) % 12];

      // 4. 小六壬推算公式：(月+日+時-2) % 6
      // 傳統數法：從大安起月，月上起日，日上起時
      let resIdx = (lunar.lMonth + lunar.lDay + hourIndex - 3) % 6;
      const result = liurenData[resIdx];

      // 顯示結果
      const resDiv = document.getElementById('result');
      resDiv.style.display = 'block';
      resDiv.innerHTML = `
<strong>【農曆時間】</strong>：${lunar.monthCn}${lunar.dayCn} ${hourName}時
<strong>【所求之事】</strong>：${q}
<strong>【推算結果】</strong>：<span style="color: #d2691e; font-size: 1.2em;">${result.name} (${result.type})</span>
<strong>【卦辭短評】</strong>：${result.desc}
      `;

      // 扣除次數
      usage++;
      localStorage.setItem('lr_usage', usage);
      updateUI();
    }

    // 監聽：點擊推算
    document.getElementById('calculateBtn').onclick = function() {
      if (getRemaining() > 0) {
        doCalculation();
      } else {
        document.getElementById('qrContainer').style.display = 'block';
        window.scrollTo(0, document.body.scrollHeight);
      }
    };

    // 監聽：點擊確認支付
    document.getElementById('confirmPayBtn').onclick = function() {
      // 1. 增加次數 (這裡增加1次額外權限)
      extra++;
      localStorage.setItem('lr_extra', extra);
      
      // 2. 更新UI（會隱藏支付框）
      updateUI();
      
      // 3. 立即執行測算
      doCalculation();
      
      alert("支付已確認，解鎖成功！");
    };

    updateUI();
  </script>
</body>
</html>

