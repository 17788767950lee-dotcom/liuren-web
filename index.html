<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>小六壬在線推算 - 傳承李淳風時課</title>
  <script src="https://cdn.jsdelivr.net/npm/solarlunar@2.0.0/lib/solarlunar.min.js"></script>
  <style>
    body { font-family: "微软雅黑", sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #fdf6e3; color: #333; line-height: 1.6; }
    h1 { text-align: center; color: #d2691e; border-bottom: 2px solid #d2691e; padding-bottom: 10px; }
    .info-card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
    #usageInfo { font-weight: bold; color: #d2691e; text-align: center; font-size: 15px; }
    
    .input-group { margin: 20px 0; }
    label { font-weight: bold; display: block; margin-bottom: 8px; }
    input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
    
    button { width: 100%; padding: 14px; background-color: #d2691e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; margin-bottom: 10px; transition: 0.3s; }
    button:hover { background-color: #b25014; }
    
    #result { margin-top: 20px; padding: 15px; background: #fffaf0; border: 2px solid #d2691e; border-radius: 8px; display: none; white-space: pre-wrap; font-size: 16px; }
    
    .qr-container { display: none; text-align: center; border: 2px dashed #d2691e; padding: 20px; background: #fff; margin-top: 20px; border-radius: 10px; }
    .qr-container img { width: 220px; height: 220px; margin: 15px 0; border: 1px solid #eee; }
    .pay-btn { background-color: #28a745; }
    .pay-btn:hover { background-color: #218838; }
    
    .footer { text-align: center; font-size: 12px; color: #999; margin-top: 40px; }
  </style>
</head>
<body>

  <h1>☯ 小六壬在線推算</h1>
  
  <div class="info-card">
    <div id="usageInfo">正在載入使用數據...</div>
  </div>

  <div class="input-group">
    <label>心中所求之事：</label>
    <input type="text" id="question" placeholder="例如：今日面試結果如何？">
  </div>

  <button id="calculateBtn">立即開始推算</button>

  <div id="result"></div>

  <div class="qr-container" id="qrContainer">
    <p style="color: #e74c3c; font-weight: bold; font-size: 18px;">免費次數已用完</p >
    <p>掃碼支付 <b>¥2</b> 即可解鎖本次及後續 1 次可用次數</p >
    <img src="alipay_qr.png" alt="支付寶收款碼">
    <button class="pay-btn" id="confirmPayBtn">我已支付，立即解鎖並查看結果</button>
  </div>

  <div class="footer">
    此算法基於唐代李淳風《六壬時課》<br>
    僅供參考，請理性對待
  </div>

  <script>
    const liurenData = [
      { name: "大安", type: "吉", desc: "大安事事昌，求財在南方。失物去不遠，宅舍保安康。" },
      { name: "留連", type: "凶", desc: "留連事難成，求謀日未明。官事只宜緩，去者未回程。" },
      { name: "速喜", type: "吉", desc: "速喜喜來臨，求財向南行。失物午未間，逢人路上尋。" },
      { name: "赤口", type: "凶", desc: "赤口主口舌，官非切宜防。失物急去尋，行人有驚慌。" },
      { name: "小吉", type: "吉", desc: "小吉最吉祥，路上好商量。陰人來報喜，失物在坤方。" },
      { name: "空亡", type: "凶", desc: "空亡事不祥，陰人少乖張。求財無利益，行人有災殃。" }
    ];

    const FREE_LIMIT = 5;

    // --- 數據持久化與獲取 ---
    function getStoredData() {
      return {
        usage: parseInt(localStorage.getItem('lr_usage') || '0'),
        extra: parseInt(localStorage.getItem('lr_extra') || '0')
      };
    }

    // --- 更新 UI 顯示 ---
    function refreshUI() {
      const data = getStoredData();
      const remain = (FREE_LIMIT + data.extra) - data.usage;
      const displayRemain = Math.max(remain, 0);
      
      document.getElementById('usageInfo').innerHTML = 
        `可用次數：<span style="font-size:1.4em; color:#d2691e;">${displayRemain}</span> <br>` +
        `<small>(免費:${FREE_LIMIT} | 已購:${data.extra} | 已用:${data.usage})</small>`;
      
      // 如果剩餘次數 > 0，隱藏支付框
      if (displayRemain > 0) {
        document.getElementById('qrContainer').style.display = 'none';
      }
    }

    // --- 核心推算邏輯 ---
    function executeCalculation() {
      const q = document.getElementById('question').value.trim();
      if (!q) {
        alert("請輸入您要占卜的事情。");
        return;
      }

      // 1. 獲取當前時間
      const now = new Date();
      // 2. 轉換農曆 (solarlunar)
      const lunar = solarLunar.solar2lunar(now.getFullYear(), now.getMonth() + 1, now.getDate());
      
      // 3. 計算時辰 (12時辰制)
      const hour = now.getHours();
      const hourIndex = Math.floor((hour + 1) / 2) % 12 + 1;
      const hourNames = ["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"];
      const currentHourName = hourNames[Math.floor((hour + 1) / 2) % 12];

      // 4. 小六壬推算公式 (月+日+時-3) % 6
      let resIdx = (lunar.lMonth + lunar.lDay + hourIndex - 3) % 6;
      const result = liurenData[resIdx];

      // 5. 展示結果
      const resDiv = document.getElementById('result');
      resDiv.style.display = 'block';
      resDiv.innerHTML = `
<strong>【農曆時間】</strong>：${lunar.monthCn}${lunar.dayCn} ${currentHourName}時
<strong>【所求之事】</strong>：${q}
<hr style="border:0; border-top:1px solid #d2691e;">
<strong>【推算結果】</strong>：<span style="color:#e74c3c; font-size:1.2em;">${result.name} (${result.type})</span>
<strong>【卦辭解析】</strong>：${result.desc}
      `;

      // 6. 記錄使用次數
      const data = getStoredData();
      localStorage.setItem('lr_usage', data.usage + 1);
      
      // 7. 更新 UI
      refreshUI();
    }

    // --- 按鈕事件監聽 ---

    // 點擊：立即推算
    document.getElementById('calculateBtn').addEventListener('click', function() {
      const data = getStoredData();
      const remain = (FREE_LIMIT + data.extra) - data.usage;

      if (remain > 0) {
        executeCalculation();
      } else {
        // 顯示支付區域並滾動到底部
        document.getElementById('qrContainer').style.display = 'block';
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      }
    });

    // 點擊：我已支付
    document.getElementById('confirmPayBtn').addEventListener('click', function() {
      // 1. 讀取並增加權限
      const data = getStoredData();
      localStorage.setItem('lr_extra', data.extra + 1);
      
      // 2. 同步 UI
      refreshUI();
      
      // 3. 直接進行推算（會消耗剛才加的這 1 次）
      executeCalculation();
      
      alert("支付確認成功！已為您解鎖測算。");
    });

    // 初始化頁面
    refreshUI();
  </script>
</body>
</html>
